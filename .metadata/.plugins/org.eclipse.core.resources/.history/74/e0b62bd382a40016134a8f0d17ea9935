var mongo = require('./mongo');

function search(msg,callback)
{
	var search_txt = msg.search_txt;
	var search_category = msg.search_category;
	var response,query;

	if(search_category != "All Categories")
		query = {"name":"//+search_txt+//"};
	else
		query = {"name":"//+search_txt+//","category":search_category};
	
	var col = mongo.collection('item');
	col.find(query,function(error,result)
	{
		if(result)
		{
			res.code = "200",
			res.value = result;
		}	
		else
		{
			console.log("returned false");
			res.code = "401";
		}	
		callback(null, res);
	});
}

function getCartNumber(msg),callback)
{
	var response;
	var col = mongo.collection('item');
	col.find(query,function(error,result)
	{
		if(result)
		{
			res.code = "200",
			res.value = result;
		}	
		else
		{
			console.log("returned false");
			res.code = "401";
		}	
		callback(null, res);
	});
	if(req.session.login)
	{
		query = "select count(user_id) as count from cart where user_id= "+req.session.login.id+"";

		mysql.fetchData(function(err,results){
			if(err)
			{
				console.log('in error');
				response = {"statusCode":401,"data":0};
				res.send(JSON.stringify(response));
			}
			else
			{
				if(results.length > 0)
				{
					response = {"statusCode":200,"data":results[0].count};
					console.log(response);
					res.send(JSON.stringify(response));
				}
				else
				{
					response = {"statusCode":403,"data":0};
					res.send(JSON.stringify(response));
				}
			}
		},query);
	}
	else
	{
		response = {"statusCode":401,data:0};
		res.send(JSON.stringify(response));
	}
}

exports.getLoginSessionValues = getLoginSessionValues;
exports.logout = logout;
exports.search = search;
exports.getSearchPage = getSearchPage;
exports.getSearchSession = getSearchSession;
exports.getCartNumber = getCartNumber;