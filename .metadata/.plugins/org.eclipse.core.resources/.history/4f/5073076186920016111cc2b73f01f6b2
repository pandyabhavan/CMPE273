ebay.controller('checkoutController', function ($scope, $http, $window,$state) {
	$scope.total = 0;
	$http({
		method: "POST",
		url: "/getCheckoutSession"
	}).success(function (data) {
		if(data.statusCode == 401)
		{
			$window.alert('Please log in first');
			$window.location = '/login';
		}
		else if(data.statusCode == 200)
		{
			$scope.total = data.data;
		}
		else
		{
			$window.location = "/";
		}
	}).error(function (error) {
		$window.alert('Something went wrong. Please try agian.');
		$window.location = "/";
	});
	
	$scope.checkout = function()
	{
		var cardNumber = $scope.card_number;
		var cvv = $scope.cvv;
		var expiry_year = $scope.expiry_year;
		var date = new Date().getTime();
		var expiry = new Date(expiry_year).getTime();
		
		if((cardNumber.toString().length !== 16 ) || (cvv.toString().length !== 3) || expiry>date)
		{
			$window.alert('Please enter the valid credit card details');
		}
		else
		{
			$http({
				method: "POST",
				url: "/getCart",
			}).success(function (data) {
				if(data.statusCode == 401)
				{
					$scope.no_item = false;
					$scope.div = true;
				}
				else if(data.statusCode == 200)
				{
					$scope.no_item = true;
					$scope.div = false;
					$scope.carts = data.data;
					$scope.subtotal = 0;
					$scope.sales_tax = 0;
					$scope.total = 0;
					for(var i=0;i<data.data.length;i++)
					{
						$scope.subtotal += Number(data.data[i].price);
					}
					$scope.sales_tax = Number((0.09*$scope.subtotal).toFixed(2));
					$scope.total = $scope.subtotal + $scope.sales_tax;
				}
				else
				{
					$scope.no_item = false;
					$scope.div = true;
					$window.location = "/";
				}
			}).error(function (error) {
				$window.alert('Something went wrong. Please try agian.');
				$window.location = "/";
			});
		}
	}
});